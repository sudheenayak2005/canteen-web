<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canteen ‚Äì Student Panel</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script>

    <style>
      body {
        background: #f8f9fa;
        font-family: "Segoe UI";
      }
      .hidden {
        display: none;
      }
      .card {
        border-radius: 12px;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
      }
      #floatingScanner {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #0d6efd;
        color: white;
        padding: 15px 22px;
        border-radius: 40px;
        cursor: pointer;
        border: none;
        font-size: 18px;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.3);
        z-index: 999;
      }
      #scannerBox {
        position: fixed;
        bottom: 80px;
        right: 10px;
        width: 320px;
        background: white;
        border-radius: 12px;
        padding: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        z-index: 999;
      }
      .scan-photo {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid #198754;
      }
    </style>
  </head>

  <body>
    <!-- LOGIN PAGE -->
    <div
      id="loginPage"
      class="card p-4 auth-card mx-auto mt-5"
      style="max-width: 400px"
    >
      <h3 class="text-center mb-3">Student Login</h3>
      <input
        id="rollInput"
        class="form-control mb-3"
        placeholder="Roll Number / ID"
      />
      <button id="loginBtn" class="btn btn-primary w-100">Login</button>
      <small class="text-muted d-block text-center mt-2"
        >Device lock enabled</small
      >
    </div>

    <!-- MAIN PAGE -->
    <div id="mainPage" class="container py-4 hidden">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h3>Welcome</h3>
          <small id="currentSlotLabel" class="text-muted"
            >Current Slot: --</small
          >
        </div>
        <button id="logoutBtn" class="btn btn-danger">Logout</button>
      </div>

      <!-- MENU PHOTO -->
      <div class="card p-3 mb-4">
        <h5>Menu</h5>
        <div id="menuPhotoBox" class="text-center mt-2">
          <span class="text-muted">Loading...</span>
        </div>
      </div>

      <!-- SUMMARY -->
      <div class="card p-3">
        <h5>Mess Summary</h5>
        <div class="row text-center mt-3">
          <div class="col-3">
            <p class="text-muted mb-1">Paid Days</p>
            <h4 id="paidDays">--</h4>
          </div>
          <div class="col-3">
            <p class="text-muted mb-1">Used</p>
            <h4 id="usedDays">--</h4>
          </div>
          <div class="col-3">
            <p class="text-muted mb-1">Remaining</p>
            <h4 id="remainingDays">--</h4>
          </div>
          <div class="col-3">
            <p class="text-muted mb-1">Carry Forward</p>
            <h4 id="cfDays">--</h4>
          </div>
        </div>
      </div>
    </div>

    <!-- FLOATING BUTTON -->
    <button id="floatingScanner" class="hidden">üì∑ Scan</button>

    <!-- SCANNER BOX -->
    <div id="scannerBox" class="hidden">
      <div id="reader" style="width: 300px"></div>
      <button class="btn btn-sm btn-danger w-100 mt-2" id="closeScanner">
        Close Scanner
      </button>
      <div id="scanResult" class="mt-2"></div>
    </div>

    <audio id="beepSound" src="/static/beep.wav"></audio>

    <script>
      let studentId = null;
      let qrScanner = null;
      let pendingToken = null;

      /* ---------------- PAGE CONTROL ---------------- */
      function showLogin() {
        loginPage.classList.remove("hidden");
        mainPage.classList.add("hidden");
        floatingScanner.classList.add("hidden");
      }

      function showMain() {
        loginPage.classList.add("hidden");
        mainPage.classList.remove("hidden");
        floatingScanner.classList.remove("hidden");

        loadMenuPhoto();
        loadSlot();
        loadSummary();

        if (pendingToken) {
          validateScan(pendingToken);
          pendingToken = null;
        }
      }

      /* ---------------- LOGIN ---------------- */
      loginBtn.onclick = async () => {
        const roll = rollInput.value.trim();
        if (!roll) return alert("Enter roll");

        const deviceId =
          localStorage.getItem("device_id") || crypto.randomUUID();
        localStorage.setItem("device_id", deviceId);

        const r = await fetch(`/api/login?roll=${roll}&device_id=${deviceId}`);
        const d = await r.json();

        if (!d.success) return alert(d.message);

        studentId = d.member_id;
        showMain();
      };

      logoutBtn.onclick = () => location.reload();

      /* ---------------- URL TOKEN (PHONE CAMERA SCAN) ---------------- */
      const urlToken = new URLSearchParams(window.location.search).get("token");
      if (urlToken) pendingToken = urlToken;

      /* ---------------- MENU PHOTO ---------------- */
      async function loadMenuPhoto() {
        const r = await fetch("/api/menu-photo");
        const d = await r.json();
        menuPhotoBox.innerHTML = d.photo
          ? `<img src="${d.photo}" class="img-fluid rounded">`
          : "<span class='text-muted'>No photo</span>";
      }

      /* ---------------- SLOT ---------------- */
      async function loadSlot() {
        const r = await fetch("/api/current-slot");
        const d = await r.json();
        currentSlotLabel.innerText = "Current Slot: " + d.slot;
      }

      /* ---------------- SUMMARY ---------------- */
      async function loadSummary() {
        if (!studentId) return;
        const r = await fetch(`/api/mess-status?id=${studentId}`);
        const d = await r.json();

        paidDays.innerText = d.paid_days;
        usedDays.innerText = d.used_days;
        remainingDays.innerText = d.remaining;
        cfDays.innerText = d.carry_forward;
      }

      /* ---------------- SCANNER (Floating Button) ---------------- */
      floatingScanner.onclick = () => openScanner();

      function openScanner() {
        scannerBox.classList.remove("hidden");

        qrScanner = new Html5Qrcode("reader");

        Html5Qrcode.getCameras().then((cams) => {
          if (!cams.length) {
            alert("No camera found");
            return;
          }

          qrScanner.start(cams[0].id, { fps: 10, qrbox: 250 }, (text) =>
            scanSuccess(text)
          );
        });
      }

      function scanSuccess(text) {
        qrScanner.pause();
        validateScan(text);
        setTimeout(() => qrScanner.resume(), 1200);
      }

      closeScanner.onclick = () => {
        scannerBox.classList.add("hidden");
        if (qrScanner) qrScanner.stop();
      };

      /* ---------------- VALIDATE SCAN ---------------- */
      async function validateScan(text) {
        let token = text;
        try {
          token = new URL(text).searchParams.get("token") || text;
        } catch {}

        const r = await fetch("/api/validate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, member_id: studentId }),
        });

        const d = await r.json();

        if (d.success) {
          beepSound.play();

          scanResult.innerHTML = `
            <div class="alert alert-success text-center">
              <img src="${
                d.photo || "/static/default.png"
              }" class="scan-photo"><br>
              <strong>${d.name}</strong><br>
              <small>Scan Successful</small>
            </div>
          `;
          loadSummary();
        } else {
          scanResult.innerHTML = `
            <div class="alert alert-danger text-center">
              ‚ùå ${d.message}
            </div>
          `;
        }
      }

      showLogin();
    </script>
  </body>
</html>
